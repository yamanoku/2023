---
title: '2023-12-15'
description: 'Notes for the week of 2023-12-15'
date: 2023-12-15
author: yamanoku
---

## Route Announcerとは何か

Single Page Application（以下 SPA）は一枚のindex.htmlを元にJavaScript側の操作で画面遷移している風に見えるルーティングの実装をしています。このためスクリーンリーダーでは、サーバーサイドから次のページ情報を送ってくる方式では問題なかった画面遷移後の情報を検知することができません。つまりSPAでは今どの画面に行ったか、どの位置にいるかが分からず操作が混乱してしまう可能性があります。

この問題を解決するためにRoute Announcer（あるいはRoute Announcement）という仕組みが存在します。

Route Announcerのおおまかな仕組みはライブリージョンというものを活用し、画面内で動的な変化があった際にそれを支援技術へ伝えるというものです。具体的には、画面遷移の挙動が発生した際にライブリージョンに遷移先のページタイトルを伝えるようにすることで、支援技術側がそれを読み上げることができ、遷移したことが分かります。

Route Announcerを活用したフレームワークはGatsby、Next.js、SvelteKit、Angular（Angular UI）、Astroが挙げられます。これらのフレームワークでの挙動では、大見出し（`<h1>`）・ページタイトル（`<title>`）が存在する順から、フォールバックとしてページのURLが読み上げられます。

---

ちなみにRoute Announcerの起源について調べてみたところ、Ember.jsの[a11y-announcer](https://github.com/ember-a11y/a11y-announcer)がそれに相当するものかなと思っていました。ですが、更に遡ると[patrickfox/a11ykit](https://github.com/patrickfox/a11ykit)から相当する挙動を参考にしているみたいです。おそらくこれが始祖に当たるものかと思っていますが、もしこれよりも前に発明されたものやアイデアがあれば是非教えてください…！

## 具体的な実装方法

次に具体的な実装方法に触れていきます。

実装コードは「[Webアプリケーションアクセシビリティ──今日から始める現場からの改善 WEB+DB PRESS](https://gihyo.jp/book/2023/978-4-297-13366-5)」より引用になります。

まずスクリーンリーダーに読み上げてもらう部分になります。

<!-- prettier-ignore-start -->
```html
<p id="announcer" role="alert" aria-live="assertive"></p>
```
<!-- prettier-ignore-end -->

`role="alert"`はユーザーに即座に重要かもしれないメッセージを通知させるためのWAI-ARIAのロールになります。

`aria-live="assertive"`は要素の内容が変更された瞬間に読み上げるする指定です。この値には他にも読み上げない`off`という値と、すべての読み上げが終わった後に通知する`polite`があります。

読み上げてもらう部分は視覚的には見えなくて良いので[Visually Hidden](https://zenn.dev/yamanoku/scraps/a6c328ccc3238c)のスタイルを付与してあげます。

<!-- prettier-ignore-start -->
```ts
const onNavigationEnd = () => {
  const announcer = document.getElementById("announcer");
  const title = document.querySelector('title').textContent;
  if (announcer instanceof HTMLElement) {
    announcer.textContent = title;  // title要素のテキストを代入する
  }
}
```

<!-- prettier-ignore-end -->

挙動については `onNavigationEnd`という関数を用意して、画面遷移が完了した際にこちらを呼び出すようにします。この関数では、`title`要素のテキストを取得してきて、要素のIDが`announcer`の中に代入しています。

これがRoute Announcerとして最低限必要な実装になります。実装をみて分かる通り`title`要素を取得してくるのでページごとで適切な

## 画面遷移後の挙動も考慮する

Route Announcerの挙動は画面遷移の開始時に発火するものです。そのため画面遷移後の挙動についても考慮する必要があります。例えば、画面遷移後には一番上のフォーカス地点に移動させるようにする必要があります。

一番分かりやすい対応としては、画面遷移後にRoute Announcerにフォーカスを当てるというものがあります。

<!-- prettier-ignore-start -->
```diff
<body>
+ <p id="announcer" role="alert" aria-live="assertive"></p>
```
<!-- prettier-ignore-end -->

まずはRoute Announcer要素を`<body>`内での一番上に設置します。

<!-- prettier-ignore-start -->
```diff
<p
  id="announcer"
+ tabindex="-1"
  role="alert"
  aria-live="assertive">
</p>
```
<!-- prettier-ignore-end -->

読み上げる要素に`tabindex="-1"`を付与します。この値があることで<kbd>Tab</kbd>キーで順番に要素へフォーカス移動する際に、その要素だけをスキップできる値になります。

```diff
  if (announcer instanceof HTMLElement) {
    announcer.textContent = title;  // title要素のテキストを代入する
+   announcer.focus();  // 読み上げる要素にフォーカスを当てる
  }
```

テキストを代入後に`focus()`を使ってフォーカスを当てることができます。これによりSPAでの画面遷移後にはページ上部へとフォーカスが移動して、通常の画面遷移と同様にフォーカス順序が上から始められるようになります。

## Navigation APIへの期待

以上より自分の現時点でもっている最適解は**ページの大見出しにフォーカスさせる**だと思っているのですが、ページによってはレイアウトが異なったり、大見出しの位置が必ず保証されているわけでもありません。現状の対応ではレイアウトを固定するような制約をもたせない限りは完全には解決できないと思っています。

この人力では解決が厳しい問題に対しての銀の弾丸になりえるのではないかと期待しているのが「[Navigation API](https://html.spec.whatwg.org/multipage/nav-history-apis.html#navigation-api)」です。こちらのAPIについてを[今年のJSConfJP](https://jsconf.jp/2023/talk/yamanoku-1/)にてLTで紹介させていただきました。

Navigation APIは、[Location API](https://developer.mozilla.org/ja/docs/Web/API/Location)や[History API](https://developer.mozilla.org/ja/docs/Web/API/History)の後継として開発されている新しいWeb APIです。このAPIを利用することで、画面遷移の開始と終了のタイミングを通知することができたり、フォーカスマネジメントやスクロール位置の復元といったことも調整しやすくなります。

## 参考情報

- [What we learned from user testing of accessible client-side routing techniques with Fable Tech Labs | Gatsby](https://www.gatsbyjs.com/blog/2019-07-11-user-testing-accessible-client-routing/)
- [WICG/navigation-api](https://github.com/wicg/navigation-api)
- [Modern client-side routing: the Navigation API - Chrome for Developers](https://developer.chrome.com/docs/web-platform/navigation-api/)
- [Navigation API による「JS での画面遷移」と SPA の改善 | blog.jxck.io](https://blog.jxck.io/entries/2022-04-22/navigation-api.html)
- [View Transitions API と Navigation API でページ遷移アニメーションを実装してみる](https://zenn.dev/yend724/articles/20230817-1bpoplim35e6eeqi)
